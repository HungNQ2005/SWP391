<%-- 
    Document   : managecdkey
    Created on : Oct 1, 2025, 4:21:06 PM
    Author     : Nguyen Quoc Hung - CE190870
    Redesigned : Bootstrap + CSS (no logic change)
--%>

<%@page contentType="text/html" pageEncoding="UTF-8"%>
<%@taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>CD Key Management</title>

        <!-- Bootstrap -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>

        <link href="http://localhost:8080/SWP391_WebXemPhimTrucTuyen/css/cdkey.css" rel="stylesheet" type="text/css"/>
        
        <link rel="stylesheet" type="text/css" href="${pageContext.request.contextPath}/css/MovieDashBoard.css"/>
    </head>

    <body>
        <%@ include file="Sidebar.jsp" %>
        <div class="container">
            <h2>CD Key Management</h2>

            <!-- Create form -->
            <form id="generate" action="${pageContext.request.contextPath}/admin/cdkey" method="post" 
                  class="row g-3 align-items-end">

                <!-- Số lượng Key -->
                <div class="col-md-3">
                    <label class="form-label fw-semibold text-light">Số lượng Key:</label>
                    <input type="number" name="count" min="1" required class="form-control">
                </div>

                <!-- Đại lý + Nút -->
                <div class="col-md-6">
                    <label class="form-label fw-semibold text-light">Đại lý:</label>
                    <div class="input-group">
                        <select name="retail" required class="form-select">
                            <option value="">-- Chọn đại lý --</option>
                            <c:forEach var="r" items="${retailList}">
                                <option value="${r.id}">${r.name}</option>
                            </c:forEach>
                        </select>
                        <button type="submit" class="btn btn-danger fw-semibold">
                            Generate & Download
                        </button>
                    </div>
                </div>

            </form>

            <script>
                document.getElementById("generate").addEventListener("submit", function () {
                    setTimeout(() => window.location.reload(), 1000);
                });
            </script>

            <!-- Tabs -->
            <div class="tabs">
                <div class="tab active" onclick="showTab('unused')">Unused Keys</div>
                <div class="tab" onclick="showTab('used')">Used Keys</div>
            </div>

            <!-- UNUSED KEYS TAB -->
            <div id="tab-unused" class="tab-content active">
                <h4 class="text-danger">Unused CD Keys</h4>
                <table class="table table-dark table-hover table-bordered align-middle">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Code</th>
                            <th>Status</th>
                            <th>Generated By</th>
                            <th>Generated Time</th>
                        </tr>
                    </thead>
                    <tbody>
                        <c:if test="${empty unusedList}">
                            <tr><td colspan="5" class="text-center text-muted">No unused keys.</td></tr>
                        </c:if>
                        <c:forEach var="k" items="${unusedList}">
                            <tr>
                                <td>${k.keyID}</td>
                                <td>${k.keyCode}</td>
                                <td>${k.keyStatus}</td>
                                <td>${k.keyGeneratedBy}</td>
                                <td>${k.keyGeneratedTime}</td>
                            </tr>
                        </c:forEach>
                    </tbody>
                </table>

                <div class="pagination">
                    <c:forEach var="i" begin="1" end="${totalUnusedPages}">
                        <c:choose>
                            <c:when test="${i == unusedPage}">
                                <b>${i}</b>
                            </c:when>
                            <c:otherwise>
                                <a href="${pageContext.request.contextPath}/admin/cdkey?unusedPage=${i}&usedPage=${usedPage}">${i}</a>
                            </c:otherwise>
                        </c:choose>
                    </c:forEach>
                </div>
            </div>

            <!-- USED KEYS TAB -->
            <div id="tab-used" class="tab-content">
                <h4 class="text-danger">Used CD Keys</h4>
                <table class="table table-dark table-hover table-bordered align-middle">
                    <thead>
                        <tr>
                            <th>Key ID</th>
                            <th>Code</th>
                            <th>Used By (username)</th>
                            <th>Used Full Name</th>
                            <th>Used At</th>
                        </tr>
                    </thead>
                    <tbody>
                        <c:if test="${empty usedList}">
                            <tr><td colspan="5" class="text-center text-muted">No used keys.</td></tr>
                        </c:if>
                        <c:forEach var="r" items="${usedList}">
                            <tr>
                                <td>${r.keyID}</td>
                                <td>${r.keyCode}</td>
                                <td>${r.usedBy}</td>
                                <td>${r.usedFullName}</td>
                                <td>${r.usedAt}</td>
                            </tr>
                        </c:forEach>
                    </tbody>
                </table>

                <div class="pagination">
                    <c:forEach var="i" begin="1" end="${totalUsedPages}">
                        <c:choose>
                            <c:when test="${i == usedPage}">
                                <b>${i}</b>
                            </c:when>
                            <c:otherwise>
                                <a href="${pageContext.request.contextPath}/admin/cdkey?usedPage=${i}&unusedPage=${unusedPage}">${i}</a>
                            </c:otherwise>
                        </c:choose>
                    </c:forEach>
                </div>
            </div>
        </div>

        <script>
            function showTab(tabName) {
                document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
                document.getElementById('tab-' + tabName).classList.add('active');
                event.target.classList.add('active');
            }
        </script>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    </body>
</html>
